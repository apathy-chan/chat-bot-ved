<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ | –§–¢–° –†–æ—Å—Å–∏–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #2d6a4f;
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            padding: 0 20px;
            font-size: 24px;
        }

        .sidebar {
            width: 250px;
            float: left;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-right: 20px;
        }

        .main-content {
            margin-left: 270px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .menu-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .menu-item:hover, .menu-item.active {
            background-color: #e8f5e9;
            color: #2d6a4f;
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2d6a4f;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .request-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .request-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .request-item:hover {
            background-color: #f9f9f9;
        }

        .request-id {
            font-weight: bold;
            color: #2d6a4f;
        }

        .request-date {
            color: #777;
            font-size: 12px;
            margin-left: 10px;
        }

        .request-text {
            margin: 5px 0;
        }

        .request-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .status-new {
            background-color: #fff3e0;
            color: #e65100;
        }

        .status-in-progress {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .status-resolved {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-closed {
            background-color: #f5f5f5;
            color: #616161;
        }

        .request-actions {
            margin-top: 10px;
        }

        .btn {
            padding: 5px 10px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .btn-primary {
            background-color: #2d6a4f;
            color: white;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-danger {
            background-color: #c62828;
            color: white;
        }

        .refresh-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #2d6a4f;
            font-size: 14px;
            margin-left: 10px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            margin-right: 5px;
        }

        .tab.active {
            border-bottom: 2px solid #2d6a4f;
            color: #2d6a4f;
            font-weight: bold;
        }

        .request-detail {
            display: none;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
            margin-top: 20px;
        }

        .request-detail.active {
            display: block;
        }

        .response-form {
            margin-top: 20px;
        }

        .response-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-height: 100px;
            margin-bottom: 10px;
        }

        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d6a4f;
            margin: 10px 0;
        }

        .stat-label {
            color: #777;
            font-size: 14px;
        }

        .knowledge-base {
            display: none;
        }

        .settings-form {
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .save-btn {
            background-color: #2d6a4f;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –í–≠–î –§–¢–° –†–æ—Å—Å–∏–∏</h1>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="menu-item active" onclick="showSection('requests')">
                <i>üìã</i> –í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
            </div>
            <div class="menu-item" onclick="showSection('stats')">
                <i>üìä</i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </div>
            <div class="menu-item" onclick="showSection('knowledge')">
                <i>üìö</i> –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
            </div>
            <div class="menu-item" onclick="showSection('settings')">
                <i>‚öôÔ∏è</i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </div>
        </div>

        <div class="main-content">
            <div id="requests-section">
                <h2 class="section-title">–û–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    <button class="refresh-btn" onclick="loadRequests()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </h2>

                <div class="tabs">
                    <div class="tab active" onclick="filterRequests('all')">–í—Å–µ</div>
                    <div class="tab" onclick="filterRequests('new')">–ù–æ–≤—ã–µ</div>
                    <div class="tab" onclick="filterRequests('in-progress')">–í —Ä–∞–±–æ—Ç–µ</div>
                    <div class="tab" onclick="filterRequests('resolved')">–ó–∞–∫—Ä—ã—Ç—ã–µ</div>
                </div>

                <ul class="request-list" id="request-list">
                    <!-- –ó–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </ul>

                <div class="request-detail" id="request-detail">
                    <div id="detail-content"></div>

                    <div class="response-form" id="response-form">
                        <h3>–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h3>
                        <textarea id="response-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
                        <button class="btn btn-primary" onclick="sendResponse()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                        <button class="btn btn-secondary" onclick="changeStatus('in-progress')">–í —Ä–∞–±–æ—Ç—É</button>
                        <button class="btn btn-secondary" onclick="changeStatus('resolved')">–†–µ—à–µ–Ω–æ</button>
                        <button class="btn btn-danger" onclick="changeStatus('closed')">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            </div>

            <div id="stats-section" style="display: none;">
                <h2 class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π</h2>

                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π</div>
                        <div class="stat-value" id="total-requests">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ù–æ–≤—ã–µ</div>
                        <div class="stat-value" id="new-requests">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
                        <div class="stat-value" id="in-progress-requests">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ó–∞–∫—Ä—ã—Ç—ã–µ</div>
                        <div class="stat-value" id="resolved-requests">0</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h3>
                    <div id="chart-container" style="height: 300px; width: 100%;">
                        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≥—Ä–∞—Ñ–∏–∫ -->
                        <img src="https://via.placeholder.com/800x300?text=–ì—Ä–∞—Ñ–∏–∫+—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏" alt="–ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏" style="width: 100%;">
                    </div>
                </div>
            </div>

            <div id="knowledge-section" style="display: none;">
                <h2 class="section-title">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h2>

                <div style="margin-bottom: 20px;">
                    <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <h3>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
                        <ul>
                            <li>–ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å?</li>
                            <li>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏</li>
                            <li>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</li>
                            <li>–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</li>
                            <li>–ü—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π —Ç–∞–º–æ–∂–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</li>
                        </ul>
                    </div>

                    <div style="flex: 1;">
                        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                        <ul>
                            <li>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –¥–æ—Å—Ç—É–ø</li>
                            <li>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å</li>
                            <li>–î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –∞—Ä—Ö–∏–≤—ã</li>
                            <li>–¢–∞–º–æ–∂–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</li>
                            <li>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="settings-section" style="display: none;">
                <h2 class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

                <div class="form-group">
                    <label>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ email</label>
                    <select>
                        <option>–í–∫–ª—é—á–µ–Ω—ã</option>
                        <option>–í—ã–∫–ª—é—á–µ–Ω—ã</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</label>
                    <select>
                        <option>–ú–æ—Å–∫–≤–∞ (UTC+3)</option>
                        <option>–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ (UTC+2)</option>
                        <option>–°–∞–º–∞—Ä–∞ (UTC+4)</option>
                        <option>–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (UTC+5)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
                    <input type="number" value="20" min="5" max="100">
                </div>

                <button class="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–¥–µ–ª–∞ -->
    <div id="section-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 5px; max-width: 500px;">
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞</h3>
            <select id="section-select" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                <option value="signature">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å</option>
                <option value="account">–õ–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç</option>
                <option value="pre-info">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                <option value="archive">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤</option>
                <option value="lk">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</option>
                <option value="customs-procedures">–¢–∞–º–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã</option>
                <option value="other">–î—Ä—É–≥–æ–µ</option>
            </select>
            <button onclick="confirmSection()" style="padding: 8px 15px; background: #2d6a4f; color: white; border: none; border-radius: 3px; cursor: pointer;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>

    <script>
        let selectedSectionId = 'other'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é "–î—Ä—É–≥–æ–µ"

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–¥–µ–ª–∞
        function showSectionModal() {
            document.getElementById('section-modal').style.display = 'flex';
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤—ã–±–æ—Ä —Ä–∞–∑–¥–µ–ª–∞
        function confirmSection() {
            selectedSectionId = document.getElementById('section-select').value;
            document.getElementById('section-modal').style.display = 'none';
            sendSupportRequest(); // –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–∞–∑–¥–µ–ª–æ–º
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É (—Å section_id)
        async function sendSupportRequest() {
            const questionText = document.getElementById('request-text').value.trim();
            if (!questionText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞!');
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/support-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: questionText,
                        user: 'user1', // –∏–ª–∏ –∏–∑ sessionStorage
                        section_id: selectedSectionId // –ü–µ—Ä–µ–¥–∞—ë–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª
                    })
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞');

                alert('–í–∞—à –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                document.getElementById('request-text').value = '';
                loadRequests(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
            }
        }
        // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        let currentRequestId = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadRequests();
            loadStats();
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª
        function showSection(section) {
            document.getElementById('requests-section').style.display = 'none';
            document.getElementById('stats-section').style.display = 'none';
            document.getElementById('knowledge-section').style.display = 'none';
            document.getElementById('settings-section').style.display = 'none';

            document.getElementById(section + '-section').style.display = 'block';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => item.classList.remove('active'));

            event.currentTarget.classList.add('active');

            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É - –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            if (section === 'stats') {
                loadStats();
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
        function filterRequests(status) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            event.currentTarget.classList.add('active');

            loadRequests(status);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadRequests(filter = 'all') {
            try {
                const response = await fetch('http://localhost:5000/api/support-requests');
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + response.status);
                }

                const data = await response.json();
                let requests = data.requests || [];

                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ
                if (requests.length === 0) {
                    requests = getTestRequests();
                } else {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
                    requests = requests.map(req => ({
                        id: 'REQ-' + req.id,
                        date: req.date_added ? new Date(req.date_added).toLocaleString('ru-RU') : new Date().toLocaleString('ru-RU'),
                        text: req.question || '',
                        status: req.status === 'resolved' ? '–†–µ—à–µ–Ω–æ' : req.status === 'new' ? '–ù–æ–≤–æ–µ' : '–í —Ä–∞–±–æ—Ç–µ',
                        response: req.answer || null,
                        section_id: req.section_id || 'other'
                    }));
                }

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                if (filter === 'new') {
                    requests = requests.filter(req => req.status === '–ù–æ–≤–æ–µ');
                } else if (filter === 'in-progress') {
                    requests = requests.filter(req => req.status === '–í —Ä–∞–±–æ—Ç–µ');
                } else if (filter === 'resolved') {
                    requests = requests.filter(req => req.status === '–†–µ—à–µ–Ω–æ');
                }

                renderRequests(requests);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                renderRequests(getTestRequests().filter(req =>
                    filter === 'all' ||
                    (filter === 'new' && req.status === '–ù–æ–≤–æ–µ') ||
                    (filter === 'in-progress' && req.status === '–í —Ä–∞–±–æ—Ç–µ') ||
                    (filter === 'resolved' && req.status === '–†–µ—à–µ–Ω–æ')
                ));
            }
        }

        // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function getTestRequests() {
            return [
                {
                    "id": "REQ-20240529120000",
                    "date": "29.05.2024 12:00",
                    "text": "–ù–µ –º–æ–≥—É –≤–æ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
                    "status": "–ù–æ–≤–æ–µ",
                    "response": null
                },
                {
                    "id": "REQ-20240528150000",
                    "date": "28.05.2024 15:00",
                    "text": "–ü—Ä–æ–±–ª–µ–º–∞ —Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é",
                    "status": "–í —Ä–∞–±–æ—Ç–µ",
                    "response": "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–ª–∞–≥–∏–Ω–∞ –ö—Ä–∏–ø—Ç–æ–ü—Ä–æ"
                },
                {
                    "id": "REQ-20240527100000",
                    "date": "27.05.2024 10:00",
                    "text": "–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?",
                    "status": "–†–µ—à–µ–Ω–æ",
                    "response": "–í —Ä–∞–∑–¥–µ–ª–µ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
                },
                {
                    "id": "REQ-20240526140000",
                    "date": "26.05.2024 14:00",
                    "text": "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞",
                    "status": "–†–µ—à–µ–Ω–æ",
                    "response": "–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ PDF –∏–ª–∏ JPEG."
                },
                {
                    "id": "REQ-20240525110000",
                    "date": "25.05.2024 11:00",
                    "text": "–í–æ–ø—Ä–æ—Å –ø–æ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º",
                    "status": "–í —Ä–∞–±–æ—Ç–µ",
                    "response": "–í–∞—à –ø–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –æ–∂–∏–¥–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è."
                }
            ];
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
        function renderRequests(requests) {
            const requestList = document.getElementById('request-list');
            requestList.innerHTML = '';

            requests.forEach(request => {
                const li = document.createElement('li');
                li.className = 'request-item';
                li.onclick = () => showRequestDetail(request);

                let statusClass = 'status-new';
                if (request.status === '–í —Ä–∞–±–æ—Ç–µ') statusClass = 'status-in-progress';
                else if (request.status === '–†–µ—à–µ–Ω–æ') statusClass = 'status-resolved';
                else if (request.status === '–ó–∞–∫—Ä—ã—Ç–æ') statusClass = 'status-closed';

                const sectionName = getSectionName(request.section_id);

                li.innerHTML = `
                    <div>
                        <span class="request-id">${request.id}</span>
                        <span class="request-date">${request.date}</span>
                        <span class="request-status ${statusClass}">${request.status}</span>
                    </div>
                    <div class="request-text">${request.text}</div>
                    ${sectionName ? `<div class="request-section">–†–∞–∑–¥–µ–ª: ${sectionName}</div>` : ''}
                    ${request.response ? `<div class="response-preview">–û—Ç–≤–µ—Ç: ${request.response.substring(0, 50)}...</div>` : ''}
                `;

                requestList.appendChild(li);
            });
        }

        function getSectionName(sectionId) {
            const sections = {
                'signature': '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å',
                'account': '–õ–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç',
                'pre-info': '–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ',
                'archive': '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤',
                'lk': '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç',
                'customs-procedures': '–¢–∞–º–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            return sections[sectionId] || '';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞–ø—Ä–æ—Å–∞
        function showRequestDetail(request) {
            currentRequestId = request.id;

            const detailContent = document.getElementById('detail-content');
            const responseForm = document.getElementById('response-form');

            let statusClass = 'status-new';
            if (request.status === '–í —Ä–∞–±–æ—Ç–µ') statusClass = 'status-in-progress';
            else if (request.status === '–†–µ—à–µ–Ω–æ') statusClass = 'status-resolved';
            else if (request.status === '–ó–∞–∫—Ä—ã—Ç–æ') statusClass = 'status-closed';

            detailContent.innerHTML = `
                <h3>–ó–∞–ø—Ä–æ—Å #${request.id}</h3>
                <p><strong>–î–∞—Ç–∞:</strong> ${request.date}</p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="request-status ${statusClass}">${request.status}</span></p>
                <p><strong>–¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞:</strong></p>
                <p>${request.text}</p>
                ${request.response ? `<p><strong>–û—Ç–≤–µ—Ç:</strong> ${request.response}</p>` : ''}
            `;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ—Ç–≤–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤ —Ä–∞–±–æ—Ç–µ
            if (request.status === '–ù–æ–≤–æ–µ' || request.status === '–í —Ä–∞–±–æ—Ç–µ') {
                responseForm.style.display = 'block';
            } else {
                responseForm.style.display = 'none';
            }

            document.getElementById('request-detail').classList.add('active');
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
         async function sendResponse() {
            const responseText = document.getElementById('response-text').value.trim();
            if (!responseText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞!');
                return;
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                const requestId = currentRequestId;
                if (!requestId) {
                    throw new Error('–ù–µ –≤—ã–±—Ä–∞–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–≤–µ—Ç–∞');
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                const updateResponse = await fetch('http://localhost:5000/api/update-spp-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: requestId.replace('REQ-', ''), // –£–¥–∞–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —á–∏—Å–ª–æ–≤–æ–≥–æ ID
                        answer: responseText,
                        status: 'processed'
                    })
                });

                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
                }

                const updateData = await updateResponse.json();
                if (!updateData.success) {
                    throw new Error(updateData.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }

                // –£—Å–ø–µ—Ö!
                alert('–û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                document.getElementById('response-text').value = '';
                loadRequests(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`);
            }
        }


        // –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞
        async function changeStatus(newStatus) {
            let statusText = '';
            if (newStatus === 'in-progress') statusText = 'in-progress';
            else if (newStatus === 'resolved') statusText = 'resolved';
            else if (newStatus === 'closed') statusText = 'closed';

            try {
                const response = await fetch('http://localhost:5000/api/update-spp-request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: currentRequestId.replace('REQ-', ''),
                        status: statusText
                    })
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');

                const data = await response.json();
                if (data.success) {
                    alert('–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω');
                    loadRequests();
                    document.getElementById('request-detail').classList.remove('active');
                } else {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (error) {
                console.error('Error changing status:', error);
                alert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetch('http://localhost:5000/api/support-requests');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');

                const data = await response.json();
                const requests = data.requests || [];

                // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                document.getElementById('total-requests').textContent = requests.length;

                // –ù–æ–≤—ã–µ
                const newRequests = requests.filter(req => req.status === 'new').length;
                document.getElementById('new-requests').textContent = newRequests;

                // –í —Ä–∞–±–æ—Ç–µ
                const inProgressRequests = requests.filter(req => req.status === 'in-progress').length;
                document.getElementById('in-progress-requests').textContent = inProgressRequests;

                // –ó–∞–∫—Ä—ã—Ç—ã–µ
                const resolvedRequests = requests.filter(req => req.status === 'resolved' || req.status === 'closed').length;
                document.getElementById('resolved-requests').textContent = resolvedRequests;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        function initializeTestData() {
            const testRequests = [
                {
                    id: "REQ-20250529120000",
                    date: "29.05.2025 12:00",
                    text: "–ù–µ –º–æ–≥—É –≤–æ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç, –ø–∏—à–µ—Ç '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'",
                    status: "–ù–æ–≤–æ–µ",
                    response: null
                },
                {
                    id: "REQ-20250528153000",
                    date: "28.05.2025 15:30",
                    text: "–ü—Ä–æ–±–ª–µ–º–∞ —Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å—å—é - –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π",
                    status: "–í —Ä–∞–±–æ—Ç–µ",
                    response: "–ú—ã –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –≤–∞—à —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫—Ä–∏–ø—Ç–æ–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞."
                },
                {
                    id: "REQ-20250527104500",
                    date: "27.05.2025 10:45",
                    text: "–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é?",
                    status: "–†–µ—à–µ–Ω–æ",
                    response: "–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏' –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –Ω–∞–∂–∞—Ç—å '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'. –ó–∞—Ç–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å."
                },
                {
                    id: "REQ-20250526164000",
                    date: "26.05.2025 16:40",
                    text: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞'",
                    status: "–ó–∞–∫—Ä—ã—Ç–æ",
                    response: "–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Å–∏—Å—Ç–µ–º—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ XML, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Ö–µ–º–µ –§–¢–°."
                },
                {
                    id: "REQ-20250525111000",
                    date: "25.05.2025 11:10",
                    text: "–í–æ–ø—Ä–æ—Å –ø–æ —Ç–∞–º–æ–∂–µ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º - –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂",
                    status: "–í —Ä–∞–±–æ—Ç–µ",
                    response: "–í–∞—à –ø–ª–∞—Ç–µ–∂ –±—ã–ª –ø–æ–ª—É—á–µ–Ω, –Ω–æ –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –û–±—ã—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –¥–æ 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π."
                }
            ];

            // –ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ
            fetch('/get_requests').then(response => {
                if (response.ok) return response.json();
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤');
            }).then(data => {
                if (!data.requests || data.requests.length === 0) {
                    testRequests.forEach(request => {
                        fetch('/add_request', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: request.text,
                                status: request.status,
                                response: request.response
                            })
                        });
                    });
                }
            }).catch(error => {
                console.error('Error checking requests:', error);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        initializeTestData();
    </script>
</body>
</html>